<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Ekstraksi Nomor Transaksi</title>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.1.1/dist/tesseract.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #000;
      color: #FFD700;
      background-image: url('https://cdn.areabermain.club/assets/cdn/az6/2025/04/02/20250402/fdde3f113c07ead01f7d121352d1dfdc/linetogel-gif-promo2.gif');
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      min-height: 100vh;
    }
    .container {
      max-width: 800px;
      margin: 20px auto;
      padding: 20px;
      border: 1px solid #FFD700;
      border-radius: 5px;
      background-color: rgba(0, 0, 0, 0.8);
      box-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
    }
    input[type="text"] {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      background-color: rgba(34, 34, 34, 0.8);
      color: #FFD700;
      border: 1px solid #FFD700;
      border-radius: 4px;
    }
    button {
      background-color: rgba(51, 51, 51, 0.8);
      color: #FFD700;
      padding: 10px 15px;
      border: 1px solid #FFD700;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s ease;
    }
    button:hover {
      background-color: rgba(85, 85, 85, 0.8);
      transform: translateY(-2px);
      box-shadow: 0 2px 5px rgba(255, 215, 0, 0.3);
    }
    #previewContainer {
      position: relative;
      margin: 15px 0;
    }
    #previewImage {
      max-width: 100%;
      border: 1px solid #FFD700;
      display: none;
      transition: all 0.3s ease;
      cursor: zoom-in;
    }
    #previewImage.minimized {
      width: 200px;
      height: auto;
      cursor: pointer;
    }
    #previewImage.zoomed {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: contain;
      background-color: rgba(0, 0, 0, 0.9);
      z-index: 1000;
      cursor: zoom-out;
      max-width: none;
    }
    #minimizeBtn {
      position: absolute;
      top: 5px;
      right: 5px;
      background-color: rgba(51, 51, 51, 0.9);
      color: #FFD700;
      border: 1px solid #FFD700;
      border-radius: 3px;
      padding: 3px 8px;
      font-size: 12px;
      display: none;
      z-index: 10;
    }
    #resultContainer {
      margin-top: 20px;
      padding: 15px;
      background-color: rgba(17, 17, 17, 0.9);
      border: 1px solid #FFD700;
      border-radius: 5px;
    }
    .transaction-list {
      font-family: monospace;
      font-size: 16px;
      line-height: 1.8;
    }
    .transaction-item {
      display: inline-block;
      margin-right: 15px;
      margin-bottom: 10px;
      padding: 5px 10px;
      background-color: rgba(34, 34, 34, 0.8);
      border: 1px solid #FFD700;
      border-radius: 3px;
      cursor: pointer;
      position: relative;
      transition: all 0.2s ease;
    }
    .transaction-item:hover {
      background-color: rgba(51, 51, 51, 0.9);
      transform: scale(1.05);
    }
    .copy-icon {
      display: inline-block;
      margin-left: 5px;
      font-size: 12px;
      opacity: 0.7;
    }
    .loading {
      color: #FFD700;
      font-weight: bold;
      margin: 10px 0;
    }
    .error {
      color: #FF6347;
      margin: 10px 0;
    }
    .notification {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background-color: rgba(51, 51, 51, 0.9);
      color: #7CFC00;
      padding: 10px 15px;
      border-radius: 4px;
      z-index: 1000;
      display: none;
      box-shadow: 0 0 10px rgba(124, 252, 0, 0.5);
    }
    #copyAllBtn {
      background-color: rgba(51, 51, 51, 0.8);
      color: #FFD700;
      padding: 5px 10px;
      border: 1px solid #FFD700;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin-left: 10px;
      transition: all 0.2s ease;
    }
    #copyAllBtn:hover {
      background-color: rgba(85, 85, 85, 0.8);
    }
    h2 {
      color: #FFD700;
      text-shadow: 0 0 5px rgba(255, 215, 0, 0.5);
      border-bottom: 1px solid #FFD700;
      padding-bottom: 10px;
    }
    h3 {
      color: #FFD700;
      text-shadow: 0 0 3px rgba(255, 215, 0, 0.3);
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>üîç Ekstraksi Nomor Transaksi</h2>
    
    <div>
      <label for="urlInput">Masukkan URL Gambar:</label>
      <input type="text" id="urlInput" placeholder="https://example.com/gambar.png">
      <p class="error" id="urlError" style="display: none;">URL tidak valid!</p>
    </div>
    
    <button onclick="processImage()">Proses Gambar</button>
    <button onclick="clearAll()" style="margin-left: 10px;">Reset</button>

    <p class="loading" id="loadingText" style="display: none;">
      ‚è≥ Sedang memproses gambar, harap tunggu...
      <span id="progressText"></span>
    </p>
    
    <div id="previewContainer">
      <img id="previewImage" alt="Preview Gambar" onclick="toggleZoom()"/>
      <button id="minimizeBtn" onclick="toggleImageSize()">Minimize</button>
    </div>
    
    <div id="resultContainer">
      <h3>üìã Daftar Nomor Transaksi: <button id="copyAllBtn" style="display: none;" onclick="copyAllTransactions()">‚éò Salin Semua</button></h3>
      <div id="transactionResults" class="transaction-list"></div>
    </div>
    
    <div id="notification" class="notification"></div>
  </div>

  <script>
    let extractedNumbers = [];
    let rawLines = [];
    let isImageMinimized = false;
    let isImageZoomed = false;

    function toggleImageSize() {
      const imgElement = document.getElementById('previewImage');
      const minimizeBtn = document.getElementById('minimizeBtn');
      
      if (isImageMinimized) {
        imgElement.classList.remove('minimized');
        minimizeBtn.textContent = 'Minimize';
        imgElement.style.cursor = 'zoom-in';
      } else {
        imgElement.classList.add('minimized');
        minimizeBtn.textContent = 'Maximize';
        imgElement.style.cursor = 'pointer';
      }
      
      isImageMinimized = !isImageMinimized;
    }

    function toggleZoom() {
      const imgElement = document.getElementById('previewImage');
      
      if (isImageZoomed) {
        imgElement.classList.remove('zoomed');
        isImageZoomed = false;
        imgElement.style.cursor = isImageMinimized ? 'pointer' : 'zoom-in';
      } else {
        imgElement.classList.add('zoomed');
        isImageZoomed = true;
        imgElement.style.cursor = 'zoom-out';
      }
    }

    async function processImage() {
      const url = document.getElementById('urlInput').value.trim();
      const imgElement = document.getElementById('previewImage');
      const minimizeBtn = document.getElementById('minimizeBtn');
      const resultContainer = document.getElementById('transactionResults');
      const loadingText = document.getElementById('loadingText');
      const progressText = document.getElementById('progressText');
      const urlError = document.getElementById('urlError');
      const copyAllBtn = document.getElementById('copyAllBtn');

      // Reset state
      resultContainer.innerHTML = '';
      urlError.style.display = 'none';
      copyAllBtn.style.display = 'none';
      extractedNumbers = [];
      rawLines = [];
      isImageMinimized = false;
      isImageZoomed = false;
      
      // Validasi URL
      if (!url) {
        urlError.textContent = "Mohon masukkan URL gambar terlebih dahulu!";
        urlError.style.display = 'block';
        return;
      }
      
      if (!isValidUrl(url)) {
        urlError.textContent = "Format URL tidak valid!";
        urlError.style.display = 'block';
        return;
      }

      // Tampilkan gambar dan loading
      imgElement.src = url;
      imgElement.style.display = 'block';
      imgElement.classList.remove('minimized', 'zoomed');
      minimizeBtn.style.display = 'block';
      loadingText.style.display = 'block';
      progressText.textContent = '';

      try {
        const result = await Tesseract.recognize(url, 'eng', {
          logger: m => {
            if (m.status === 'recognizing text') {
              const progress = Math.round(m.progress * 100);
              progressText.textContent = `(${progress}%)`;
            }
            console.log(m);
          },
          tessedit_pageseg_mode: 6,
          tessedit_char_whitelist: '0123456789'
        });

        const rawText = result.data.text;
        console.log("Raw OCR Result:", rawText);
        
        // Simpan baris mentah untuk diproses
        rawLines = rawText.split('\n').filter(line => line.trim().length > 0);
        
        extractTransactionNumbers();
        
      } catch (error) {
        console.error("OCR Error:", error);
        resultContainer.innerHTML = `
          <div class="error">
            ‚ùå Gagal memproses gambar: ${error.message}
          </div>
        `;
      } finally {
        loadingText.style.display = 'none';
      }
    }

    function extractTransactionNumbers() {
      const resultContainer = document.getElementById('transactionResults');
      const copyAllBtn = document.getElementById('copyAllBtn');
      
      // Proses setiap baris untuk menemukan nomor transaksi
      for (let i = 0; i < rawLines.length; i++) {
        const line = rawLines[i].trim();
        
        // Pola untuk menemukan nomor transaksi (9-10 digit)
        const transactionRegex = /\b\d{9,10}\b/;
        const match = line.match(transactionRegex);
        
        if (match) {
          // Jika baris berikutnya juga berisi angka panjang, gabungkan
          if (i + 1 < rawLines.length) {
            const nextLine = rawLines[i + 1].trim();
            const nextMatch = nextLine.match(/\b\d{8,}\b/); // Minimal 8 digit
            
            if (nextMatch) {
              const combinedNumber = match[0] + nextMatch[0];
              extractedNumbers.push(combinedNumber);
              i++; // Lewati baris berikutnya karena sudah diproses
              continue;
            }
          }
          
          // Jika tidak ada baris berikutnya yang cocok, simpan nomor saja
          extractedNumbers.push(match[0]);
        }
      }
      
      // Hapus duplikat
      extractedNumbers = [...new Set(extractedNumbers)];
      
      // Render hasil
      if (extractedNumbers.length > 0) {
        extractedNumbers.forEach(num => {
          const itemDiv = document.createElement('div');
          itemDiv.className = 'transaction-item';
          itemDiv.innerHTML = `${num} <span class="copy-icon">‚éò</span>`;
          
          itemDiv.addEventListener('click', function() {
            copyToClipboard(num, 'Nomor berhasil disalin!');
          });
          
          resultContainer.appendChild(itemDiv);
        });
        
        copyAllBtn.style.display = 'inline';
      } else {
        resultContainer.innerHTML = `
          <div class="error">
            ‚ö†Ô∏è Tidak ditemukan nomor transaksi dalam gambar.
            <p>Berikut teks yang berhasil diekstrak:</p>
            <pre style="background: rgba(34, 34, 34, 0.8); padding: 10px; border: 1px solid #FFD700;">${rawLines.join('\n')}</pre>
          </div>
        `;
      }
    }

    function copyToClipboard(text, message) {
      // Coba menggunakan Clipboard API modern
      if (navigator.clipboard) {
        navigator.clipboard.writeText(text).then(() => {
          showNotification(message);
        }).catch(err => {
          console.error('Gagal menggunakan Clipboard API:', err);
          useFallbackCopy(text, message);
        });
      } else {
        // Fallback untuk browser lama
        useFallbackCopy(text, message);
      }
    }

    function useFallbackCopy(text, message) {
      const textarea = document.createElement('textarea');
      textarea.value = text;
      textarea.style.position = 'fixed';
      textarea.style.opacity = '0';
      document.body.appendChild(textarea);
      textarea.select();
      
      try {
        const successful = document.execCommand('copy');
        if (successful) {
          showNotification(message);
        } else {
          console.error('Fallback copy gagal');
        }
      } catch (err) {
        console.error('Fallback copy error:', err);
      } finally {
        document.body.removeChild(textarea);
      }
    }

    function showNotification(message) {
      const notification = document.getElementById('notification');
      notification.textContent = message;
      notification.style.display = 'block';
      
      setTimeout(() => {
        notification.style.display = 'none';
      }, 2000);
    }

    function copyAllTransactions() {
      if (extractedNumbers.length > 0) {
        copyToClipboard(extractedNumbers.join('\n'), 'Semua nomor berhasil disalin!');
      }
    }

    function isValidUrl(string) {
      try {
        new URL(string);
        return true;
      } catch (_) {
        return false;
      }
    }

    function clearAll() {
      document.getElementById('urlInput').value = '';
      const imgElement = document.getElementById('previewImage');
      imgElement.style.display = 'none';
      imgElement.classList.remove('minimized', 'zoomed');
      document.getElementById('minimizeBtn').style.display = 'none';
      document.getElementById('minimizeBtn').textContent = 'Minimize';
      document.getElementById('transactionResults').innerHTML = '';
      document.getElementById('urlError').style.display = 'none';
      document.getElementById('copyAllBtn').style.display = 'none';
      extractedNumbers = [];
      rawLines = [];
      isImageMinimized = false;
      isImageZoomed = false;
    }
  </script>
</body>
</html>
